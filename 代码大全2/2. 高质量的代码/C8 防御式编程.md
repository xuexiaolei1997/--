# 防御式编程

## 8.1 保护程序，使其免受无效输入的影响

一般有三种方法来处理：

检查来源于外部的所有数据的值

检查子程序所有输入参数的值

决定如何处理错误的输入数据

## 8.2 断言

自己构建断言机制

```cpp
#define ASSERT( condition, message ) {     \
    if ( !(condition) ) {                  \
	LogError( "Assertion failed: ",    \
		#condition, message );     \
	exit( EXIT_FAILURE );              \
    }                                      \
}                                          \
```

### 使用断言的指导原则

用错误处理代码来处理预期会发生的情况；用断言来处理永远不应该发生的情况

避免将要执行的代码放到断言中

使用断言来声明和验证前置条件和后置条件

对健壮性要求很高的代码，应先使用断言再处理错误

## 8.3 错误处理技术

返回中立值

换用下一条有效数据

返回与上次相同的答案

换用最接近的合法值

在文件中记录警告信息

返回一个错误代码

调用错误处理子程序或对象

在遇到错误的地方显示出错消息

用最妥当的方式在局部处理错误

关闭程序

### 健壮性与正确性

### 高层级设计对错误处理方式的影响

## 8.4 异常

使用异常来通知程序其他部分不应忽略的错误

仅在真正异常的情况下才抛出异常

不要使用异常来推卸责任

除非是在同一位置捕获，否则避免在构造函数和析构函数中抛出异常

在合适的抽象层级抛出异常

在异常消息中包括导致异常的所有信息

避免使用空的catch块

了解库代码锁抛出的异常

考虑创建一个集中式异常报告程序

把项目中对异常的使用标准化

考虑异常的替代方案

## 8.5 隔离程序，使之包容由错误造成的损害

在输入时将输入数据转换为合适的类型

### 隔栏与断言的关系

隔栏的使用使断言和错误处理之间的区别变得清晰。隔栏外部的子程序应使用错误处理技术，因为对数据进行任何假定都是不安全的。而隔栏内部的子程序应该使用断言，因为传递给它们的数据应该在通过隔栏之前就已经被清理过。如果隔栏内部的某个子程序检测到数据错误，则说明这是程序出错而不是数据出错。

隔栏的使用还说明了在架构层级上决定如何处理错误的价值。确定隔栏内外的代码是架构层级上的决策。

## 8.6 调试辅助代码

#### 不要自动将生产版本的约束应用于开发版本

#### 尽早引入调试辅助代码

#### 使用进攻式编程

确保断言语句可以使程序终止运行。不要让程序员养成遇到已知问题只知道按回车键绕过的习惯。要让问题痛苦到必须进行修复。

完全填充分配到的所有内存，以便可以检测内存分配方面的错误。

完全填充分配到的所有文件或流，以便可以排查任何文件格式错误。

确保每个case语句中的default分支或else分支都能产生严重错误，比如说让程序终止运行，或者至少让这些错误不会被忽视。

在删除对象之前使其填满垃圾数据。

让程序把错误日志文件通过电子邮件发送给你，让你可以看到已发布软件中发生的各种错误。

#### 计划删除调试辅助代码

#### 使用版本控制工具和类似ant与make这样的构建工具

#### 使用内置的预处理器

#### 自己动手写预处理器

#### 使用调试桩

## 8.7 确定在生产代码中保留多少防御式代码

#### 保留用于检查重要错误的代码

#### 删除用于检查微不足道错误的代码

#### 删除导致硬性崩溃的代码

#### 保留有助于程序优雅崩溃的代码

#### 为技术支持人员记录错误信息

#### 确认留下的错误信息是友好的

## 8.8 对防御式编程采取防御的姿态

> 检查清单：防御式编程
>
> | 项       | 具体内容                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
> | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
> | 一般事宜 | 子程序是否可以保护自己免遭错误输入数据的破坏？<br />是否使用断言来声明假设，包括前置条件和后置条件？<br />断言是否仅用于声明永远不应该发生的情况？<br />是否在架构或高层级设计中指定了一组特定的错误处理技术？<br />是否在架构或高层级设计中规定了错误处理是应更倾向于健壮性还是正确性？<br />是否建立了隔板来包容错误可能造成的破坏，并减少于错误处理有关的代码数量？<br />代码中是否使用了辅助调试代码？<br />如果要启动和停用辅助调试代码，是否不需要大动干戈？<br />防御式编程引入的代码的数量是否合适，既不太多，也不太少？<br />在开发阶段是否使用进攻式编程技术来使错误很难被忽视？ |
> | 异常     | 在项目中是否定义了一种标准化的异常处理方法？<br />是否考虑过异常之外的其他替代方案？<br />错误是不是已尽可能在局部处理，而不是作为异常向外抛出？<br />代码中是否避免了在构造函数和析构函数中抛出异常？<br />是否所有的异常都与抛出它们的子程序处于同一抽象层次上？<br />每个异常是否包含了关于异常发生的所有背景信息？<br />代码中是否没有使用空的catch块？或者，如果使用空的catch块确实很合适，是不是明确声明了？                                                                                                                                                                         |
> | 安全事宜 | 检查错误输入数据的代码是否也检查了缓冲区溢出、SQL注入、HTML注入、整数溢出和其他恶意输入？<br />是否检查了所有错误返回码？<br />是否捕获了所有的异常？<br />出错消息中是否避免了出现有助于攻击者攻入系统的信息？                                                                                                                                                                                                                                                                                                                                                                            |
